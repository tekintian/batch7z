#!/usr/bin/env bash
#
# æ‰¹é‡å‹ç¼©å·¥å…·ï¼ˆé…å¥— batchun7z è§£å‹å·¥å…·ï¼‰
# ===================== ä½¿ç”¨è¯´æ˜ =====================
# ç”¨é€”ï¼š
#   1. å°†ç›®æ ‡ç›®å½•ä¸‹çš„ä¸€çº§å­ç›®å½•æ‰¹é‡å‹ç¼©ä¸º .7z åŒ…
#   2. å°†å½“å‰ç›®å½•ä¸‹çš„éå‹ç¼©åŒ…æ–‡ä»¶æ‰“åŒ…ä¸º _files_ æ—¥æœŸæ ¼å¼çš„ .7z åŒ…
# æ³¨æ„äº‹é¡¹ï¼š
#   1. å­ç›®å½•è¿‡æ»¤ï¼š${FILTER_FILES[*]}
#   2. å½“å‰ç›®å½•å·²å‹ç¼©æ ¼å¼ï¼ˆä¸å†æ‰“åŒ…ï¼‰ï¼š${CUR_PACKED_FORMATS[*]}
#
# åŸºæœ¬ç”¨æ³•ï¼š
#   batch7z                          # å‹ç¼©å½“å‰ç›®å½•æ‰€æœ‰å­ç›®å½•å’Œæ–‡ä»¶
#   batch7z -d /path/to/dir          # å‹ç¼©æŒ‡å®šç›®å½•
#   batch7z -p 123456                # è®¾ç½®å‹ç¼©åŒ…å¯†ç 
#   batch7z -h                       # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
#
# ä½¿ç”¨å®ä¾‹ï¼š
#   # åœºæ™¯1ï¼šå¤‡ä»½å½“å‰é¡¹ç›®çš„æ‰€æœ‰å­ç›®å½•
#   cd /Volumes/work/wwwroot
#   batch7z
#
#   # åœºæ™¯2ï¼šå‹ç¼©æŒ‡å®šç›®å½•å¹¶è®¾ç½®å¯†ç 
#   batch7z -d ~/Desktop/projects -p mypassword
#
#   # åœºæ™¯3ï¼šå‹ç¼©å¤šä¸ªéƒ¨ç½²åŒ…ï¼Œæ–¹ä¾¿ä¼ è¾“
#   cd /var/www/vhosts
#   batch7z -p deploy2026
#
# ===================== é…ç½®è¯´æ˜ =====================
# - å‹ç¼©æ ¼å¼ï¼š.7zï¼ˆé«˜å‹ç¼©æ¯”ï¼Œå…¼å®¹ WinRARã€BetterZip ç­‰ï¼‰
# - å‹ç¼©ç®—æ³•ï¼šLZMA2 (xz)
# - è‡ªåŠ¨è¿‡æ»¤ï¼š*.log .DS_Store node_modules
# - å½“å‰ç›®å½•å·²å‹ç¼©æ ¼å¼ï¼ˆä¸å†æ‰“åŒ…ï¼‰ï¼š*.7z *.rar *.gz *.xz *.zip *.tar *.tgz *.bz2 *.iso *.dmg
# - æ–‡ä»¶å‘½åï¼š
#   * å­ç›®å½•ï¼šå­ç›®å½•å_YYYY-MM-DD_HH-MM.7z
#   * æ–‡ä»¶ï¼šå½“å‰ç›®å½•å_files_YYYY-MM-DD_HH-MM.7z
# - é»˜è®¤å¯†ç ï¼šä¸è®¾ç½®å¯†ç 
#
# ===================== ç³»ç»Ÿè¦æ±‚ =====================
# éœ€å…ˆå®‰è£… p7zipï¼šbrew install p7zip
# =================================================== 

# å®šä¹‰é»˜è®¤é…ç½®ï¼ˆæ— æ”¹åŠ¨ï¼Œä¿ç•™åŸåŠŸèƒ½ï¼‰
DEFAULT_PASSWORD=""
DEFAULT_DIR="$(pwd)"
FILTER_FILES=("*.log" "*.tmp" ".DS_Store" "node_modules/" ".next/" "__MACOSX/" "Thumbs.db")
# å®šä¹‰å·²å‹ç¼©çš„æ–‡ä»¶æ ¼å¼ï¼ˆä¸éœ€è¦å†æ¬¡æ‰“åŒ…çš„å‹ç¼©æ–‡ä»¶ï¼‰
CUR_PACKED_FORMATS=("*.7z" "*.rar" "*.gz" "*.xz" "*.zip" "*.tar" "*.tgz" "*.bz2" "*.iso" "*.dmg")

# å®šä¹‰ help å¸®åŠ©ä¿¡æ¯å‡½æ•°ï¼ˆæ— æ”¹åŠ¨ï¼‰
show_help() {
    echo "===== batch7z æ‰¹é‡å‹ç¼©å·¥å…· ä½¿ç”¨å¸®åŠ© ====="
    echo "ç”¨é€”ï¼š"
    echo "  1. æ‰¹é‡å‹ç¼©ç›®æ ‡ç›®å½•ä¸‹çš„ä¸€çº§å­ç›®å½•ä¸º .7z åŒ…ï¼ˆé‡‡ç”¨ xz å‹ç¼©ç®—æ³•ï¼‰"
    echo "  2. æ‰“åŒ…å½“å‰ç›®å½•ä¸‹çš„éå‹ç¼©åŒ…æ–‡ä»¶ä¸º _files_ æ—¥æœŸæ ¼å¼çš„ .7z åŒ…"
    echo "æ ¼å¼ï¼šbatch7z [é€‰é¡¹]..."
    echo ""
    echo "å¯é€‰çŸ­é€‰é¡¹å‚æ•°ï¼š"
    echo "  -d [ç›®å½•è·¯å¾„]   ï¼šæŒ‡å®šç›®æ ‡å‹ç¼©ç›®å½•ï¼ˆé»˜è®¤ï¼šå½“å‰å·¥ä½œç›®å½•ï¼‰"
    echo "  -p [å¯†ç ]       ï¼šæŒ‡å®šå‹ç¼©åŒ…å¯†ç ï¼ˆé»˜è®¤ï¼šä¸è®¾ç½®å¯†ç ï¼‰"
    echo "  -h              ï¼šæ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯å¹¶é€€å‡º"
    echo ""
    echo "é…ç½®è¯´æ˜ï¼š"
    echo "  1. å‹ç¼©æ ¼å¼ï¼š.7zï¼ˆå…¼å®¹ BetterZipã€WinRAR ç­‰å¸¸è§„å‹ç¼©è½¯ä»¶ï¼‰"
    echo "  2. å‹ç¼©ç®—æ³•ï¼šxzï¼ˆLZMA2ï¼‰ï¼Œé«˜å‹ç¼©æ¯”"
    echo "  3. è‡ªåŠ¨è¿‡æ»¤ï¼š${FILTER_FILES[*]}"
    echo "  4. å½“å‰ç›®å½•å·²å‹ç¼©æ ¼å¼ï¼ˆä¸å†æ‰“åŒ…ï¼‰ï¼š${CUR_PACKED_FORMATS[*]}"
    echo "  5. æ–‡ä»¶åæ ¼å¼ï¼š"
    echo "     - å­ç›®å½•ï¼šå­ç›®å½•å_YYYY-MM-DDTHH-MM.7z"
    echo "     - æ–‡ä»¶ï¼šå½“å‰ç›®å½•å_files_YYYY-MM-DDTHH-MM.7z"
    echo "  6. ç³»ç»Ÿéœ€è¦å…ˆå®‰è£…ï¼šbrew install p7zipï¼ˆmacOS å…¨å±€æ¨èï¼‰"
    echo "=========================================="
}

# å‰ç½®æ ¡éªŒï¼šæ£€æŸ¥7zå·¥å…·æ˜¯å¦å®‰è£…ï¼ˆæ— æ”¹åŠ¨ï¼Œå…œåº•æ’æŸ¥ï¼‰
if ! command -v 7z &> /dev/null; then
    echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°7zå‘½ä»¤ï¼Œè¯·å…ˆå®‰è£…p7zipå·¥å…·ï¼"
    echo "  macOS å…¨å±€å®‰è£…ï¼šbrew install p7zip"
    exit 1
fi

# åˆå§‹åŒ–å‚æ•°ï¼ˆé»˜è®¤ä½¿ç”¨é»˜è®¤å€¼ï¼Œæ— æ”¹åŠ¨ï¼‰
TARGET_DIR="${DEFAULT_DIR}"
COMPRESS_PASSWORD="${DEFAULT_PASSWORD}"

# æ ¸å¿ƒï¼šä½¿ç”¨ getopts è§£æçŸ­é€‰é¡¹å‚æ•°ï¼ˆ-dã€-pã€-hï¼Œæ— æ”¹åŠ¨ï¼‰
while getopts "d:p:h" opt; do
    case "${opt}" in
        d)
            TARGET_DIR="${OPTARG}"
            if [ ! -d "${TARGET_DIR}" ]; then
                echo "âŒ é”™è¯¯ï¼š-d é€‰é¡¹æŒ‡å®šçš„ç›®å½• '${TARGET_DIR}' ä¸å­˜åœ¨æˆ–æ— æ•ˆï¼"
                exit 1
            fi
            ;;
        p)
            COMPRESS_PASSWORD="${OPTARG}"
            ;;
        h)
            show_help
            exit 0
            ;;
        \?)
            echo "âŒ é”™è¯¯ï¼šæ— æ•ˆçš„é€‰é¡¹ '-${OPTARG}'ï¼"
            echo ""
            show_help
            exit 1
            ;;
        :)
            echo "âŒ é”™è¯¯ï¼šé€‰é¡¹ '-${OPTARG}' ç¼ºå°‘å¿…è¦å‚æ•°ï¼"
            echo ""
            show_help
            exit 1
            ;;
    esac
done

# åˆ‡æ¢åˆ°ç›®æ ‡ç›®å½•ï¼ˆåˆ‡æ¢å¤±è´¥åˆ™é€€å‡ºï¼Œæ— æ”¹åŠ¨ï¼‰
cd "${TARGET_DIR}" || {
    echo "âŒ é”™è¯¯ï¼šæ— æ³•åˆ‡æ¢åˆ°ç›®æ ‡ç›®å½• '${TARGET_DIR}'ï¼Œè¯·æ£€æŸ¥ç›®å½•æƒé™ï¼"
    exit 1
}

# ç”Ÿæˆæ—¥æœŸæ ‡è¯†ï¼ˆä¿ç•™åŸæ ¼å¼ï¼Œå…¨å±€å…¼å®¹ï¼‰
CURRENT_DATE=$(date +"%Y-%m-%d_%H-%M")

# è¾“å‡ºä»»åŠ¡é…ç½®ä¿¡æ¯ï¼ˆè§„èŒƒå˜é‡å¼•ç”¨ï¼Œæ— å…¼å®¹é—®é¢˜ï¼‰
echo "===== å¼€å§‹æ‰¹é‡å‹ç¼©å­ç›®å½•ä»»åŠ¡ ====="
echo "ç›®æ ‡å·¥ä½œç›®å½•ï¼š$(pwd)"
if [ -z "${COMPRESS_PASSWORD}" ]; then
    echo "å‹ç¼©é…ç½®ï¼šæ¯ä¸ªå­ç›®å½•å•ç‹¬æ‰“åŒ…ï¼Œæ— å¯†ç "
else
    echo "å‹ç¼©é…ç½®ï¼šæ¯ä¸ªå­ç›®å½•å•ç‹¬æ‰“åŒ…ï¼Œå¯†ç =å·²è®¾ç½®ï¼ˆéšè—æ˜¾ç¤ºï¼‰"
fi
echo "å‹ç¼©æ ¼å¼ï¼š.7zï¼ˆé‡‡ç”¨ xz å‹ç¼©ç®—æ³•ï¼Œå…¼å®¹å¸¸è§„å‹ç¼©è½¯ä»¶ï¼‰"
echo "å­ç›®å½•è¿‡æ»¤ï¼š${FILTER_FILES[*]}"
echo "æ—¥æœŸæ ‡è¯†ï¼š${CURRENT_DATE}ï¼ˆæ ¼å¼ï¼šå¹´-æœˆ-æ—¥Tæ—¶-åˆ†é’Ÿï¼‰"
echo "-----------------------------"

# ã€å…¨å±€å‘½ä»¤æ ¸å¿ƒæ”¹é€ ï¼šæ”¾å¼ƒå˜é‡æ‹¼æ¥ï¼Œç›´æ¥æ‰§è¡ŒåŸç”Ÿ7zå‘½ä»¤ï¼Œæ— Bashé«˜çº§è¯­æ³•ã€‘
# æ‰¹é‡å‹ç¼©å­ç›®å½•ï¼ˆå…¼å®¹æ‰€æœ‰ç¯å¢ƒï¼Œå…¨å±€è°ƒç”¨æ— æŠ¥é”™ï¼‰
find . -maxdepth 1 -type d -not -name . -print0 | while IFS= read -r -d '' dir; do
    # æå–çº¯å­ç›®å½•åç§°
    dir_name=$(basename "${dir}")
    # å®šä¹‰å‹ç¼©åŒ…æ–‡ä»¶åï¼ˆè§„èŒƒå˜é‡å¼•ç”¨ï¼Œé¿å…è§£æé”™è¯¯ï¼‰
    compress_file="${dir_name}_${CURRENT_DATE}.7z"

    # è·³è¿‡å·²å­˜åœ¨çš„åŒåå‹ç¼©åŒ…
    if [ -f "${compress_file}" ]; then
        echo "âš ï¸  å·²å­˜åœ¨å‹ç¼©åŒ… ${compress_file}ï¼Œè·³è¿‡å‹ç¼©"
        continue
    fi

    echo "æ­£åœ¨å‹ç¼©ï¼š${dir_name} â†’ ${compress_file}ï¼ˆè¿‡æ»¤ ${FILTER_FILES[*]}ï¼‰"

    # æ ¸å¿ƒï¼š7zåŸºç¡€å‘½ä»¤ï¼ˆæ— æ•°ç»„ï¼Œç›´æ¥å†™å›ºå®šå‚æ•°ï¼‰
    # æ ¹æ®æ˜¯å¦è®¾ç½®å¯†ç å†³å®šæ˜¯å¦ä½¿ç”¨ -p å‚æ•°
    if [ -z "${COMPRESS_PASSWORD}" ]; then
        7z a \
            -t7z \
            -mx=9 \
            -m0=LZMA2 \
            "${compress_file}" "${dir_name}" \
            $(for filter in "${FILTER_FILES[@]}"; do echo "-xr!${filter}"; done)
    else
        7z a \
            -t7z \
            -mx=9 -p"${COMPRESS_PASSWORD}" \
            -m0=LZMA2 \
            "${compress_file}" "${dir_name}" \
            $(for filter in "${FILTER_FILES[@]}"; do echo "-xr!${filter}"; done)
    fi

    # æ ¡éªŒå‹ç¼©ç»“æœå¹¶æ¸…ç†æ— æ•ˆæ–‡ä»¶
    if [ ${?} -eq 0 ]; then
        if [ -z "${COMPRESS_PASSWORD}" ]; then
            echo "âœ… ${compress_file} å‹ç¼©æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
        else
            echo "âœ… ${compress_file} å‹ç¼©æˆåŠŸï¼ˆå¯†ç ï¼šå·²è®¾ç½®ï¼Œéšè—æ˜¾ç¤ºï¼‰"
        fi
    else
        echo "âŒ ${compress_file} å‹ç¼©å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç›®å½•æƒé™æˆ–å·¥å…·å®Œæ•´æ€§"
        [ -f "${compress_file}" ] && rm -f "${compress_file}"
    fi
done

# æ–°å¢åŠŸèƒ½ï¼šå‹ç¼©å½“å‰ç›®å½•ä¸‹éå‹ç¼©åŒ…æ–‡ä»¶ï¼ˆä¸€çº§å­ç›®å½•å¤–çš„æ–‡ä»¶ï¼‰
echo "-----------------------------"
echo "å¼€å§‹æ£€æŸ¥å¹¶æ‰“åŒ…å½“å‰ç›®å½•æ–‡ä»¶ï¼ˆæ’é™¤å·²å‹ç¼©æ ¼å¼ï¼‰..."

# è·å–å½“å‰ç›®å½•åï¼ˆä½œä¸ºå‹ç¼©åŒ…å‰ç¼€ï¼‰
current_dir_name=$(basename "$(pwd)")

# å®šä¹‰æ–‡ä»¶åŒ…æ–‡ä»¶å
files_package="${current_dir_name}_files_${CURRENT_DATE}.7z"

# è·³è¿‡å·²å­˜åœ¨çš„æ–‡ä»¶åŒ…
if [ -f "${files_package}" ]; then
    echo "âš ï¸  å·²å­˜åœ¨æ–‡ä»¶åŒ… ${files_package}ï¼Œè·³è¿‡å‹ç¼©"
else
    # æ„å»ºæ’é™¤å·²å‹ç¼©æ–‡ä»¶æ ¼å¼çš„ find å‚æ•°
    exclude_args=""
    for format in "${CUR_PACKED_FORMATS[@]}"; do
        exclude_args="${exclude_args} ! -name \"${format}\""
    done

    # æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„ä¸€çº§æ–‡ä»¶ï¼ˆæ’é™¤ç›®å½•ã€æ’é™¤å·²å‹ç¼©çš„æ–‡ä»¶æ ¼å¼ï¼‰
    file_count=$(eval "find . -maxdepth 1 -type f ${exclude_args} 2>/dev/null" | wc -l | tr -d ' ')

    if [ "${file_count}" -gt 0 ]; then
        echo "å‘ç° ${file_count} ä¸ªæ–‡ä»¶å¾…æ‰“åŒ…ï¼ˆæ’é™¤å·²å‹ç¼©æ ¼å¼ï¼š${CUR_PACKED_FORMATS[*]}ï¼‰..."
        echo "æ­£åœ¨æ‰“åŒ…æ–‡ä»¶ï¼š${files_package}"

        # æ„å»ºè¿‡æ»¤å‚æ•°
        filter_params=$(for filter in "${FILTER_FILES[@]}"; do echo -n " -xr!${filter}"; done)

        # æ ¹æ®æ˜¯å¦è®¾ç½®å¯†ç å†³å®šæ˜¯å¦ä½¿ç”¨ -p å‚æ•°
        if [ -z "${COMPRESS_PASSWORD}" ]; then
            # ç›´æ¥ä½¿ç”¨ find çš„è¾“å‡ºä¼ é€’ç»™ 7zï¼Œä¸ç»è¿‡ eval å’Œ sort
            eval "find . -maxdepth 1 -type f ${exclude_args} 2>/dev/null" | while IFS= read -r file; do
                if [ -n "${file}" ]; then
                    7z a -t7z -mx=9 -m0=LZMA2 "${files_package}" ${filter_params} "${file}"
                fi
            done

            # æ ¡éªŒå‹ç¼©ç»“æœï¼šæ£€æŸ¥å‹ç¼©åŒ…æ˜¯å¦æœ‰æ•ˆï¼ˆéç©ºï¼‰
            if [ -f "${files_package}" ]; then
                # æ£€æŸ¥å‹ç¼©åŒ…å¤§å°ï¼Œå¦‚æœä¸º 0 å­—èŠ‚åˆ™åˆ é™¤
                file_size=$(wc -c < "${files_package}" 2>/dev/null | tr -d ' ')
                if [ "${file_size}" -eq 0 ] 2>/dev/null; then
                    echo "âš ï¸  ${files_package} å‹ç¼©åŒ…ä¸ºç©ºï¼Œå·²åˆ é™¤"
                    rm -f "${files_package}"
                else
                    echo "âœ… ${files_package} å‹ç¼©æˆåŠŸï¼ˆæ— å¯†ç ï¼Œå¤§å°ï¼š$(du -h "${files_package}" | cut -f1)ï¼‰"
                fi
            else
                echo "âŒ ${files_package} å‹ç¼©å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æƒé™æˆ–å·¥å…·å®Œæ•´æ€§"
            fi
        else
            # ç›´æ¥ä½¿ç”¨ find çš„è¾“å‡ºä¼ é€’ç»™ 7zï¼Œä¸ç»è¿‡ eval å’Œ sort
            eval "find . -maxdepth 1 -type f ${exclude_args} 2>/dev/null" | while IFS= read -r file; do
                if [ -n "${file}" ]; then
                    7z a -t7z -mx=9 -p"${COMPRESS_PASSWORD}" -m0=LZMA2 "${files_package}" ${filter_params} "${file}"
                fi
            done

            # æ ¡éªŒå‹ç¼©ç»“æœï¼šæ£€æŸ¥å‹ç¼©åŒ…æ˜¯å¦æœ‰æ•ˆï¼ˆéç©ºï¼‰
            if [ -f "${files_package}" ]; then
                # æ£€æŸ¥å‹ç¼©åŒ…å¤§å°ï¼Œå¦‚æœä¸º 0 å­—èŠ‚åˆ™åˆ é™¤
                file_size=$(wc -c < "${files_package}" 2>/dev/null | tr -d ' ')
                if [ "${file_size}" -eq 0 ] 2>/dev/null; then
                    echo "âš ï¸  ${files_package} å‹ç¼©åŒ…ä¸ºç©ºï¼Œå·²åˆ é™¤"
                    rm -f "${files_package}"
                else
                    echo "âœ… ${files_package} å‹ç¼©æˆåŠŸï¼ˆå¯†ç ï¼šå·²è®¾ç½®ï¼Œéšè—æ˜¾ç¤ºï¼Œå¤§å°ï¼š$(du -h "${files_package}" | cut -f1)ï¼‰"
                fi
            else
                echo "âŒ ${files_package} å‹ç¼©å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æƒé™æˆ–å·¥å…·å®Œæ•´æ€§"
                [ -f "${files_package}" ] && rm -f "${files_package}"
            fi
        fi
    else
        echo "å½“å‰ç›®å½•ä¸‹æ²¡æœ‰éœ€è¦æ‰“åŒ…çš„æ–‡ä»¶ï¼ˆå·²æ’é™¤å‹ç¼©æ ¼å¼ï¼š${CUR_PACKED_FORMATS[*]}ï¼‰"
    fi
fi

# ä»»åŠ¡ç»“æŸç»Ÿè®¡ï¼ˆä¿ç•™åŸåŠŸèƒ½ï¼Œå…¨å±€å…¼å®¹ï¼‰
echo "-----------------------------"
echo "ğŸ“Š æœ¬æ¬¡ä»»åŠ¡ç”Ÿæˆå‹ç¼©åŒ…ç»Ÿè®¡ï¼š"
total_count=$(ls -l ./*_"${CURRENT_DATE}".7z 2>/dev/null | wc -l)
total_size=$(du -sb ./*_"${CURRENT_DATE}".7z 2>/dev/null | awk '{sum+=$1} END {print sum}' | numfmt --to=iec 2>/dev/null || echo "0B")
echo "  æ€»æ•°é‡ï¼š${total_count} ä¸ª"
echo "  æ€»å¤§å°ï¼š${total_size}ï¼ˆäººæ€§åŒ–æ˜¾ç¤ºï¼‰"
echo "-----------------------------"
echo "===== æ‰¹é‡å‹ç¼©å­ç›®å½•ä»»åŠ¡æ‰§è¡Œå®Œæ¯• ====="