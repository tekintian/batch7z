#!/usr/bin/env bash
#
# æ‰¹é‡å‹ç¼©å·¥å…·ï¼ˆé…å¥— batchun7z è§£å‹å·¥å…·ï¼‰
# ===================== ä½¿ç”¨è¯´æ˜ =====================
# ç”¨é€”ï¼š
#   1. å°†ç›®æ ‡ç›®å½•ä¸‹çš„ä¸€çº§å­ç›®å½•æ‰¹é‡å‹ç¼©ä¸º .7z åŒ…
#   2. å°†å½“å‰ç›®å½•ä¸‹çš„éå‹ç¼©åŒ…æ–‡ä»¶æ‰“åŒ…ä¸º _files_ æ—¥æœŸæ ¼å¼çš„ .7z åŒ…
# æ³¨æ„äº‹é¡¹ï¼š
#   1. å­ç›®å½•è¿‡æ»¤ï¼š${FILTER_FILES[*]}
#   2. å½“å‰ç›®å½•å·²å‹ç¼©æ ¼å¼ï¼ˆä¸å†æ‰“åŒ…ï¼‰ï¼š${CUR_PACKED_FORMATS[*]}
#
# åŸºæœ¬ç”¨æ³•ï¼š
#   batch7z                          # å‹ç¼©å½“å‰ç›®å½•æ‰€æœ‰å­ç›®å½•å’Œæ–‡ä»¶
#   batch7z -d /path/to/dir          # å‹ç¼©æŒ‡å®šç›®å½•
#   batch7z -p 123456                # è®¾ç½®å‹ç¼©åŒ…å¯†ç 
#   batch7z -h                       # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
#
# ä½¿ç”¨å®ä¾‹ï¼š
#   # åœºæ™¯1ï¼šå¤‡ä»½å½“å‰é¡¹ç›®çš„æ‰€æœ‰å­ç›®å½•
#   cd /Volumes/work/wwwroot
#   batch7z
#
#   # åœºæ™¯2ï¼šå‹ç¼©æŒ‡å®šç›®å½•å¹¶è®¾ç½®å¯†ç 
#   batch7z -d ~/Desktop/projects -p mypassword
#
#   # åœºæ™¯3ï¼šå‹ç¼©å¤šä¸ªéƒ¨ç½²åŒ…ï¼Œæ–¹ä¾¿ä¼ è¾“
#   cd /var/www/vhosts
#   batch7z -p deploy2026
#
# ===================== é…ç½®è¯´æ˜ =====================
# - å‹ç¼©æ ¼å¼ï¼š.7zï¼ˆé«˜å‹ç¼©æ¯”ï¼Œå…¼å®¹ WinRARã€BetterZip ç­‰ï¼‰
# - å‹ç¼©ç®—æ³•ï¼šLZMA2 (xz)
# - è‡ªåŠ¨è¿‡æ»¤ï¼š*.log .DS_Store node_modules
# - å½“å‰ç›®å½•å·²å‹ç¼©æ ¼å¼ï¼ˆä¸å†æ‰“åŒ…ï¼‰ï¼š*.7z *.rar *.gz *.xz *.zip *.tar *.tgz *.bz2 *.iso *.dmg
# - æ–‡ä»¶å‘½åï¼š
#   * å­ç›®å½•ï¼šå­ç›®å½•å_YYYY-MM-DD_HH-MM.7z
#   * æ–‡ä»¶ï¼šå½“å‰ç›®å½•å_files_YYYY-MM-DD_HH-MM.7z
# - é»˜è®¤æ— å¯†ç 
#
# ===================== ç³»ç»Ÿè¦æ±‚ =====================
# éœ€å…ˆå®‰è£… p7zipï¼šbrew install p7zipï¼ˆmacOSï¼‰| apt install p7zip-fullï¼ˆLinuxï¼‰
# =================================================== 

# å®šä¹‰é»˜è®¤é…ç½®
DEFAULT_PASSWORD=""
DEFAULT_DIR="$(pwd)"
FILTER_FILES=("*.log" "*.tmp" ".DS_Store" "node_modules/" ".next/" "__MACOSX/" "Thumbs.db")
CUR_PACKED_FORMATS=("*.7z" "*.rar" "*.gz" "*.xz" "*.zip" "*.tar" "*.tgz" "*.bz2" "*.iso" "*.dmg")

# å®šä¹‰ help å¸®åŠ©ä¿¡æ¯å‡½æ•°
show_help() {
    echo "===== batch7z æ‰¹é‡å‹ç¼©å·¥å…· ä½¿ç”¨å¸®åŠ© ====="
    echo "ç”¨é€”ï¼š"
    echo "  1. æ‰¹é‡å‹ç¼©ç›®æ ‡ç›®å½•ä¸‹çš„ä¸€çº§å­ç›®å½•ä¸º .7z åŒ…ï¼ˆé‡‡ç”¨ xz å‹ç¼©ç®—æ³•ï¼‰"
    echo "  2. æ‰“åŒ…å½“å‰ç›®å½•ä¸‹çš„éå‹ç¼©åŒ…æ–‡ä»¶ä¸º _files_ æ—¥æœŸæ ¼å¼çš„ .7z åŒ…"
    echo "æ ¼å¼ï¼šbatch7z [é€‰é¡¹]..."
    echo ""
    echo "å¯é€‰çŸ­é€‰é¡¹å‚æ•°ï¼š"
    echo "  -d [ç›®å½•è·¯å¾„]   ï¼šæŒ‡å®šç›®æ ‡å‹ç¼©ç›®å½•ï¼ˆé»˜è®¤ï¼šå½“å‰å·¥ä½œç›®å½•ï¼‰"
    echo "  -p [å¯†ç ]       ï¼šæŒ‡å®šå‹ç¼©åŒ…å¯†ç ï¼ˆé»˜è®¤ï¼š${DEFAULT_PASSWORD}ï¼‰"
    echo "  -h              ï¼šæ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯å¹¶é€€å‡º"
    echo ""
    echo "é…ç½®è¯´æ˜ï¼š"
    echo "  1. å‹ç¼©æ ¼å¼ï¼š.7zï¼ˆå…¼å®¹ BetterZipã€WinRAR ç­‰å¸¸è§„å‹ç¼©è½¯ä»¶ï¼‰"
    echo "  2. å‹ç¼©ç®—æ³•ï¼šxzï¼ˆLZMA2ï¼‰ï¼Œé«˜å‹ç¼©æ¯”"
    echo "  3. è‡ªåŠ¨è¿‡æ»¤ï¼š${FILTER_FILES[*]}"
    echo "  4. å½“å‰ç›®å½•å·²å‹ç¼©æ ¼å¼ï¼ˆä¸å†æ‰“åŒ…ï¼‰ï¼š${CUR_PACKED_FORMATS[*]}"
    echo "  5. æ–‡ä»¶åæ ¼å¼ï¼š"
    echo "     - å­ç›®å½•ï¼šå­ç›®å½•å_YYYY-MM-DD_HH-MM.7z"
    echo "     - æ–‡ä»¶ï¼šå½“å‰ç›®å½•å_files_YYYY-MM-DD_HH-MM.7z"
    echo "  6. ç³»ç»Ÿéœ€è¦å…ˆå®‰è£…ï¼šp7zipï¼ˆmacOSï¼šbrew install p7zip | Linuxï¼šapt install p7zip-fullï¼‰"
    echo "  7. è¿›åº¦æ˜¾ç¤ºï¼šå¯ç”¨å®æ—¶ç™¾åˆ†æ¯”è¿›åº¦ï¼Œå‹ç¼©è¿‡ç¨‹ä¸­å¯æŸ¥çœ‹æ‰§è¡ŒçŠ¶æ€"
    echo "=========================================="
}

# å‰ç½®æ ¡éªŒï¼šæ£€æŸ¥7zå·¥å…·æ˜¯å¦å®‰è£…
if ! command -v 7z &> /dev/null; then
    echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°7zå‘½ä»¤ï¼Œè¯·å…ˆå®‰è£…p7zipå·¥å…·ï¼"
    echo "  macOS å®‰è£…ï¼šbrew install p7zip"
    echo "  Linux å®‰è£…ï¼šapt install p7zip-fullï¼ˆDebian/Ubuntuï¼‰| yum install p7zipï¼ˆCentOS/RHELï¼‰"
    exit 1
fi

# å°è£…ï¼šåˆ¤æ–­7zå‹ç¼©åŒ…æ˜¯å¦æœ‰æ•ˆ(éç©º)
# å‡½æ•°åï¼šis_7z_archive_valid
# å‚æ•°è¯´æ˜ï¼š
#   $1ï¼šå¿…å¡«ï¼Œ7zå‹ç¼©åŒ…æ–‡ä»¶è·¯å¾„ï¼ˆç›´æ¥ä¼ å…¥ï¼Œå¿½ç•¥è·¯å¾„/ç›®å½•é¢å¤–æ ¡éªŒï¼‰
# è¿”å›å€¼ï¼ˆ$?ï¼‰ï¼š
#   0ï¼šå‹ç¼©åŒ…ä¸ºç©ºï¼ˆçº¯ç©ºåŒ…/ä»…å«ç›®å½•/ä»…å«éšè—æ— æ•ˆæ–‡ä»¶ï¼‰
#   1ï¼šå‹ç¼©åŒ…åŒ…å«æœ‰æ•ˆæ–‡ä»¶
is_7z_archive_valid() {
    # æ­¥éª¤1ï¼šåˆå§‹åŒ–å˜é‡ï¼ˆç›´æ¥è°ƒç”¨å…¨å±€å¯†ç å˜é‡ COMPRESS_PASSWORDï¼‰
    local archive_path="$1"
    local valid_file_count=0

    # æ­¥éª¤2ï¼šæ„å»º7zå‘½ä»¤å‚æ•°æ•°ç»„ï¼ˆç›´æ¥åˆ¤æ–­å…¨å±€å¯†ç å˜é‡æ˜¯å¦ä¸ºç©ºï¼‰
    local x7z_args=(
        "l"
        "-bb0"
        "-slt"
        "${archive_path}"
    )
    # ç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œéç©ºåˆ™è¿½åŠ å¯†ç å‚æ•°
    if [ -n "${COMPRESS_PASSWORD}" ]; then
        x7z_args+=("-p${COMPRESS_PASSWORD}")
    fi

    # æ­¥éª¤3ï¼šæ ¸å¿ƒé€»è¾‘ï¼šè§£æ7zå®˜æ–¹è¾“å‡ºï¼Œç»Ÿè®¡æœ‰æ•ˆæ–‡ä»¶æ•°ï¼ˆä¿ç•™æ ¸å¿ƒè¿‡æ»¤ï¼‰
    valid_file_count=$(
        7z "${x7z_args[@]}" 2>/dev/null | \
        awk '/Path = / {path=$0} /Attributes = / {attrs=$0; print path "\t" attrs}' | \
        grep -v -E "\.DS_Store|Thumbs.db|Attributes = D_" | \
        wc -l
    )

    # æ­¥éª¤4ï¼šæ ¹æ®æœ‰æ•ˆæ–‡ä»¶æ•°è¿”å›å¯¹åº”çŠ¶æ€ç 
    if [ "${valid_file_count}" -gt 0 ]; then
        return 1  # æœ‰æ•ˆ
    else
        return 0  # ç©ºåŒ…
    fi
}


# åˆå§‹åŒ–å‚æ•°
TARGET_DIR="${DEFAULT_DIR}"
COMPRESS_PASSWORD="${DEFAULT_PASSWORD}"

# æ ¸å¿ƒï¼šä½¿ç”¨ getopts è§£æçŸ­é€‰é¡¹å‚æ•°ï¼ˆ-dã€-pã€-hï¼‰
while getopts "d:p:h" opt; do
    case "${opt}" in
        d)
            TARGET_DIR="${OPTARG}"
            if [ ! -d "${TARGET_DIR}" ]; then
                echo "âŒ é”™è¯¯ï¼š-d é€‰é¡¹æŒ‡å®šçš„ç›®å½• '${TARGET_DIR}' ä¸å­˜åœ¨æˆ–æ— æ•ˆï¼"
                exit 1
            fi
            ;;
        p)
            COMPRESS_PASSWORD="${OPTARG}"
            ;;
        h)
            show_help
            exit 0
            ;;
        \?)
            echo "âŒ é”™è¯¯ï¼šæ— æ•ˆçš„é€‰é¡¹ '-${OPTARG}'ï¼"
            echo ""
            show_help
            exit 1
            ;;
        :)
            echo "âŒ é”™è¯¯ï¼šé€‰é¡¹ '-${OPTARG}' ç¼ºå°‘å¿…è¦å‚æ•°ï¼"
            echo ""
            show_help
            exit 1
            ;;
    esac
done

# åˆ‡æ¢åˆ°ç›®æ ‡ç›®å½•ï¼ˆåˆ‡æ¢å¤±è´¥åˆ™é€€å‡ºï¼‰
cd "${TARGET_DIR}" || {
    echo "âŒ é”™è¯¯ï¼šæ— æ³•åˆ‡æ¢åˆ°ç›®æ ‡ç›®å½• '${TARGET_DIR}'ï¼Œè¯·æ£€æŸ¥ç›®å½•æƒé™ï¼"
    exit 1
}

# ç”Ÿæˆæ—¥æœŸæ ‡è¯†ï¼ˆå…¨å±€å…¼å®¹ï¼‰
CURRENT_DATE=$(date +"%Y-%m-%d_%H-%M")

# æ„å»º7zè¿‡æ»¤å‚æ•°æ•°ç»„ï¼ˆå®‰å…¨ï¼Œé¿å…å­—ç¬¦ä¸²è§£æé£é™©ï¼‰
xz_filter_args=()
for filter in "${FILTER_FILES[@]}"; do
    xz_filter_args+=(-xr!"${filter}")
done

# è¾“å‡ºä»»åŠ¡é…ç½®ä¿¡æ¯
echo "===== å¼€å§‹æ‰¹é‡å‹ç¼©å­ç›®å½•ä»»åŠ¡ ====="
echo "ç›®æ ‡å·¥ä½œç›®å½•ï¼š$(pwd)"
if [ -z "${COMPRESS_PASSWORD}" ]; then
    echo "å‹ç¼©é…ç½®ï¼šæ¯ä¸ªå­ç›®å½•å•ç‹¬æ‰“åŒ…ï¼Œæ— å¯†ç "
else
    echo "å‹ç¼©é…ç½®ï¼šæ¯ä¸ªå­ç›®å½•å•ç‹¬æ‰“åŒ…ï¼Œå¯†ç =å·²è®¾ç½®ï¼ˆéšè—æ˜¾ç¤ºï¼‰"
fi
echo "å‹ç¼©æ ¼å¼ï¼š.7zï¼ˆé‡‡ç”¨ xz å‹ç¼©ç®—æ³•ï¼Œå…¼å®¹å¸¸è§„å‹ç¼©è½¯ä»¶ï¼‰"
echo "å­ç›®å½•è¿‡æ»¤ï¼š${FILTER_FILES[*]}"
echo "æ—¥æœŸæ ‡è¯†ï¼š${CURRENT_DATE}ï¼ˆæ ¼å¼ï¼šå¹´-æœˆ-æ—¥_æ—¶-åˆ†é’Ÿï¼‰"
echo "è¿›åº¦æ˜¾ç¤ºï¼šå¯ç”¨å®æ—¶ç™¾åˆ†æ¯”è¿›åº¦ï¼Œå‹ç¼©è¿‡ç¨‹ä¸­å¯æŸ¥çœ‹è¯¦ç»†çŠ¶æ€"
echo "-----------------------------"

# æ‰¹é‡å‹ç¼©å­ç›®å½•ï¼ˆå…¼å®¹ç‰¹æ®Šæ–‡ä»¶åï¼Œé«˜æ•ˆæ— å†—ä½™ï¼Œå¸¦è¿›åº¦æ˜¾ç¤ºï¼‰
find . -maxdepth 1 -type d -not -name . -print0 | while IFS= read -r -d '' dir; do
    # æå–çº¯å­ç›®å½•åç§°
    dir_name=$(basename "${dir}")
    # å®šä¹‰å‹ç¼©åŒ…æ–‡ä»¶å
    compress_file="${dir_name}_${CURRENT_DATE}.7z"

    # è·³è¿‡å·²å­˜åœ¨çš„åŒåå‹ç¼©åŒ…
    if [ -f "${compress_file}" ]; then
        echo "âš ï¸  å·²å­˜åœ¨å‹ç¼©åŒ… ${compress_file}ï¼Œè·³è¿‡å‹ç¼©"
        continue
    fi

    echo "æ­£åœ¨å‹ç¼©ï¼š${dir_name} â†’ ${compress_file}ï¼ˆè¿‡æ»¤ ${FILTER_FILES[*]}ï¼‰"
    echo "-----------------------------"

    # æ„å»º7zæ ¸å¿ƒå‚æ•°ï¼ˆæ·»åŠ -bsp1å¯ç”¨ç™¾åˆ†æ¯”è¿›åº¦æ˜¾ç¤ºï¼‰
    xz_core_args=(-t7z -mx=9 -m0=LZMA2 "${xz_filter_args[@]}" "${compress_file}" "${dir_name}")
    [ -n "${COMPRESS_PASSWORD}" ] && xz_core_args+=(-p"${COMPRESS_PASSWORD}")

    # ä¸€æ¬¡æ€§æ‰¹é‡æ‰“åŒ…ï¼ˆç§»é™¤é™é»˜è¾“å‡ºï¼Œæ·»åŠ -bsp1æ˜¾ç¤ºå®æ—¶è¿›åº¦ï¼Œä¿ç•™7zåŸç”Ÿè¾“å‡ºï¼‰
    7z a -bsp1 "${xz_core_args[@]}"

    # æ ¡éªŒå‹ç¼©ç»“æœå¹¶æ¸…ç†æ— æ•ˆæ–‡ä»¶
    if [ ${?} -eq 0 ]; then
        # äºŒæ¬¡æ ¡éªŒï¼šåˆ¤æ–­å‹ç¼©åŒ…æ˜¯å¦ä¸ºç©ºï¼ˆæœ€ä¸¥è°¨ï¼‰
        is_7z_archive_valid "${compress_file}"
        if [ ${?} -eq 0 ]; then
            echo "âš ï¸  ${compress_file} å‹ç¼©åŒ…ä¸ºç©ºï¼Œå·²åˆ é™¤"
            rm -f "${compress_file}"
            continue
        fi
        echo "âœ… ${compress_file} å‹ç¼©æˆåŠŸï¼ˆ$( [ -z "${COMPRESS_PASSWORD}" ] && echo "æ— å¯†ç " || echo "å¯†ç ï¼šå·²è®¾ç½®ï¼Œéšè—æ˜¾ç¤º" )ï¼‰"
    else
        echo "âŒ ${compress_file} å‹ç¼©å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç›®å½•æƒé™æˆ–å·¥å…·å®Œæ•´æ€§"
        [ -f "${compress_file}" ] && rm -f "${compress_file}"
    fi
    echo "-----------------------------"
done

# å‹ç¼©å½“å‰ç›®å½•ä¸‹éå‹ç¼©åŒ…æ–‡ä»¶ï¼ˆæ— evalï¼Œé«˜æ•ˆå®‰å…¨ï¼Œå¸¦è¿›åº¦æ˜¾ç¤ºï¼‰
echo "-----------------------------"
echo "å¼€å§‹æ£€æŸ¥å¹¶æ‰“åŒ…å½“å‰ç›®å½•æ–‡ä»¶ï¼ˆæ’é™¤å·²å‹ç¼©æ ¼å¼ï¼‰..."

# è·å–å½“å‰ç›®å½•åï¼ˆä½œä¸ºå‹ç¼©åŒ…å‰ç¼€ï¼‰
current_dir_name=$(basename "$(pwd)")
# å®šä¹‰æ–‡ä»¶åŒ…æ–‡ä»¶å
files_package="${current_dir_name}_files_${CURRENT_DATE}.7z"

# è·³è¿‡å·²å­˜åœ¨çš„æ–‡ä»¶åŒ…
if [ -f "${files_package}" ]; then
    echo "âš ï¸  å·²å­˜åœ¨æ–‡ä»¶åŒ… ${files_package}ï¼Œè·³è¿‡å‹ç¼©"
else
    # æ„å»ºfindæ’é™¤å‚æ•°æ•°ç»„ï¼ˆæ— evalï¼ŒåŸç”Ÿå®‰å…¨ï¼Œå»æ‰å¤šä½™åŒå¼•å·ï¼‰
    # é»˜è®¤æ’é™¤  .DS_Store Thumb.db æ–‡ä»¶
    find_exclude_args=(! -iname ".DS_Store" ! -iname "Thumb.db")
    for format in "${CUR_PACKED_FORMATS[@]}"; do
        find_exclude_args+=(! -iname "${format}")  # ä½¿ç”¨-inameå¿½ç•¥å¤§å°å†™ï¼Œå…¼å®¹æ€§æ›´å¼º
    done

    # æŸ¥æ‰¾ç›®æ ‡æ–‡ä»¶å¹¶è¯»å–åˆ°æ•°ç»„ï¼ˆå…¼å®¹Bash 3.2+ï¼Œæ”¯æŒç‰¹æ®Šæ–‡ä»¶åï¼Œè¿‡æ»¤ç©ºè¡Œï¼‰
    target_files=()
    if command -v mapfile &> /dev/null; then
        # æ”¯æŒmapfileçš„ç³»ç»Ÿï¼ˆLinuxã€Bash 4.0+ï¼‰
        mapfile -t target_files < <(find . -maxdepth 1 -type f "${find_exclude_args[@]}" 2>/dev/null)
    else
        # å…¼å®¹macOSï¼ˆBash 3.2ï¼‰
        while IFS= read -r file; do
            [[ -n "${file}" ]] && target_files+=("${file}")
        done < <(find . -maxdepth 1 -type f "${find_exclude_args[@]}" 2>/dev/null)
    fi
    # è¿‡æ»¤ç©ºå…ƒç´ 
    target_files=("${target_files[@]//''/}")
    file_count=${#target_files[@]}

    if [ "${file_count}" -gt 0 ]; then
        echo "å‘ç° ${file_count} ä¸ªæ–‡ä»¶å¾…æ‰“åŒ…ï¼ˆæ’é™¤å·²å‹ç¼©æ ¼å¼ï¼š${CUR_PACKED_FORMATS[*]}ï¼‰..."
        echo "æ­£åœ¨æ‰“åŒ…æ–‡ä»¶ï¼š${files_package}"
        echo "-----------------------------"

        # æ„å»º7zæ ¸å¿ƒå‚æ•°ï¼ˆæ·»åŠ -bsp1å¯ç”¨ç™¾åˆ†æ¯”è¿›åº¦æ˜¾ç¤ºï¼‰
        xz_core_args=(-t7z -mx=9 -m0=LZMA2 "${xz_filter_args[@]}" "${files_package}")
        [ -n "${COMPRESS_PASSWORD}" ] && xz_core_args+=(-p"${COMPRESS_PASSWORD}")

        # ä¸€æ¬¡æ€§æ‰¹é‡æ‰“åŒ…ï¼ˆç§»é™¤é™é»˜è¾“å‡ºï¼Œæ·»åŠ -bsp1æ˜¾ç¤ºå®æ—¶è¿›åº¦ï¼Œä¿ç•™7zåŸç”Ÿè¾“å‡ºï¼‰
        7z a -bsp1 "${xz_core_args[@]}" "${target_files[@]}"

        # æ ¡éªŒå‹ç¼©ç»“æœå¹¶æ¸…ç†æ— æ•ˆæ–‡ä»¶
        is_7z_archive_valid "${files_package}"
        is_empty=$?
        
        if [ -f "${files_package}" ] && [ "${is_empty}" -ne 0 ]; then
            package_size=$(du -h "${files_package}" | cut -f1)
            echo "âœ… ${files_package} å‹ç¼©æˆåŠŸï¼ˆ$( [ -z "${COMPRESS_PASSWORD}" ] && echo "æ— å¯†ç " || echo "å¯†ç ï¼šå·²è®¾ç½®ï¼Œéšè—æ˜¾ç¤º" )ï¼Œå¤§å°ï¼š${package_size}ï¼‰"
        else
            echo "âŒ ${files_package} å‹ç¼©å¤±è´¥æˆ–ç”Ÿæˆç©ºåŒ…ï¼Œå·²æ¸…ç†æ— æ•ˆæ–‡ä»¶"
            [ -f "${files_package}" ] && rm -f "${files_package}"
        fi
    else
        echo "å½“å‰ç›®å½•ä¸‹æ²¡æœ‰éœ€è¦æ‰“åŒ…çš„æ–‡ä»¶ï¼ˆå·²æ’é™¤å‹ç¼©æ ¼å¼ï¼š${CUR_PACKED_FORMATS[*]}ï¼‰"
    fi
fi

# ä»»åŠ¡ç»“æŸç»Ÿè®¡ï¼ˆå…¼å®¹ç‰¹æ®Šæ–‡ä»¶åï¼Œç»Ÿè®¡å‡†ç¡®ï¼‰
echo "-----------------------------"
echo "ğŸ“Š æœ¬æ¬¡ä»»åŠ¡ç”Ÿæˆå‹ç¼©åŒ…ç»Ÿè®¡ï¼š"
# ç”¨findç»Ÿè®¡ï¼Œå…¼å®¹ç‰¹æ®Šæ–‡ä»¶å
total_count=$(find . -maxdepth 1 -type f -name "*_${CURRENT_DATE}.7z" 2>/dev/null | wc -l)
# è®¡ç®—æ€»å¤§å°å¹¶äººæ€§åŒ–æ˜¾ç¤º
total_size=$(find . -maxdepth 1 -type f -name "*_${CURRENT_DATE}.7z" -exec du -sb {} + 2>/dev/null | awk '{sum+=$1} END {print sum}')
total_size_human=$(numfmt --to=iec --suffix=B "${total_size}" 2>/dev/null || echo "0B")
echo "  æ€»æ•°é‡ï¼š${total_count} ä¸ª"
echo "  æ€»å¤§å°ï¼š${total_size_human}ï¼ˆäººæ€§åŒ–æ˜¾ç¤ºï¼‰"
echo "-----------------------------"
echo "===== æ‰¹é‡å‹ç¼©å­ç›®å½•ä»»åŠ¡æ‰§è¡Œå®Œæ¯• ====="